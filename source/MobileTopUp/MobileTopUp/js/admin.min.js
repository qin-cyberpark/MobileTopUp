function ChangeBrand(n){$(".brand-brief").removeClass("brief-selected");$(".brand-brief[brand-type="+n+"]").addClass("brief-selected");ShowBrandAvailable(n)}function ShowModel(n,t,i,r,u){$("#formOperation").val(n);$("#oriBrand").val(i?i:$(".brief-selected").attr("brand-type"));$("#brandSelector").val(i?i:$(".brief-selected").attr("brand-type"));$("#oriTopupNumber").val(u?u:"");$("#topupNumber").val(u?u:"");$("#topupNumberConfirm").val(u?u:"");$("#oriSerialNumber").val(r?r:"");$("#serialNumber").val(r?r:"");switch(n){case"ADD":$("#btnAdd").show();$("#btnSave").hide();break;case"UPDATE":$("#btnSave").show();$("#btnAdd").hide();break;default:$("#btnAdd").hide();$("#btnSave").hide()}$(".alert").remove();$("#editModal").modal("show")}function ShowUpdateModal(n,t,i){ShowModel("UPDATE",!1,n,t,i)}function ShowDelModal(n,t,i){n&&t&&i&&($("#delBrand").val(n),$("#delTopupNumber").val(i),$("#delSerialNumber").val(t),$("#confirmMsg").find(".delete-prompt").html([n,"<br/>SN-",t,"<br/>",i].join("")),$("#delModal").modal("show"))}function CheckInputData(n){return!$.isNumeric($("#topupNumber").val())||!$.isNumeric($("#topupNumberConfirm").val())||!$.isNumeric($("#serialNumber").val())?(alert("Invalid value",!0),!1):$("#topupNumber").val()!=$("#topupNumberConfirm").val()?(alert("Twice voucher number not match",!0),!1):$("#topupNumber").val().length!=12?(alert("Top up number should be 12-digit",!0),!1):n&&$("#oriBrand").val()==$("#brandSelector").val()&&$("#oriTopupNumber").val()==$("#topupNumber").val()&&$("#oriSerialNumber").val()==$("#serialNumber").val()?(alert("nothing is changed",!0),!1):!0}function AddVoucher(){if(!CheckInputData())return!1;var n=$_form.attr("add-url"),t=new FormData($_form[0]);return $.ajax(n,{type:"post",data:t,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){$("#btnAdd").prop("disabled",!0)},complete:function(){$("#btnAdd").prop("disabled",!1)},success:function(n){if(n.added){$("#topupNumber").val("");$("#topupNumberConfirm").val("");$("#serialNumber").val("");var t=[n.voucher_brand,n.voucher_sn,"-",n.voucher_no,"added"].join(" ");alert(t);UpdateStatistic();ChangeBrand(n.voucher_brand)}else n.fail?alert(n.message,!0):alert("Failed to add voucher",!0)},error:function(n,t,i){alert(t||i,!0)}}),!1}function DeleteVoucher(){var n=$("#formDelVoucher").attr("action"),t=new FormData($("#formDelVoucher")[0]);return $.ajax(n,{type:"post",data:t,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){$("#btnConfirm").prop("disabled",!0)},complete:function(){$("#btnConfirm").prop("disabled",!1)},success:function(n){if(n.deleted){$("#delBrand").val("");$("#delSerialNumber").val("");$("#delTopupNumber").val("");var t=[n.voucher_brand,n.voucher_sn,"-",n.voucher_no,"deleted"].join(" ");UpdateStatistic();ChangeBrand(n.voucher_brand);$("#delModal").modal("hide")}else n.fail?alertOnMain(n.message,!0):alertOnMain("Failed to add voucher",!0)},error:function(n,t,i){alertOnMain(t||i,!0)}}),!1}function UpdateVoucher(){if(!CheckInputData(!0))return!1;var n=$_form.attr("update-url"),t=new FormData($_form[0]);return $.ajax(n,{type:"post",data:t,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){$("#btnSave").prop("disabled",!0)},complete:function(){$("#btnSave").prop("disabled",!1)},success:function(n){if(n.updated){var t=[n.ori_voucher_brand,n.ori_voucher_sn,"-",n.ori_voucher_no,"updated to",n.voucher_brand,n.voucher_sn,"-",n.voucher_no].join(" ");$("#oriBrand").val($("#brandSelector").val());$("#oriTopupNumber").val($("#topupNumber").val());$("#oriSerialNumber").val($("#serialNumber").val());UpdateStatistic();ChangeBrand(n.voucher_brand);$("#editModal").modal("hide")}else n.fail?alert(n.message,!0):alert("Failed to update voucher",!0)},error:function(n,t,i){alert(t||i,!0)}}),!1}function UpdateStatistic(){$.getJSON("GetStatistic",function(n){console.debug(n);_statisticData=n;$("#updatedTime").html("updated at "+_statisticData.UpdatedTime);ShowBrandBrief();var t=$(".brief-selected").attr("brand-type");ShowBrandAvailable(t);setTimeout(UpdateStatistic,6e4)}).fail(function(){console.log("ads")})}function ShowBrandBrief(){$panels=$(".brand-brief");$.each($panels,function(n,t){var r=$(t),u=r.attr("brand-type"),i=_statisticData[u];$remaining=r.find(".remaining");$remaining.html(i.AVAILABLE);i.AVAILABLE<=3?$remaining.addClass("low-stock"):$remaining.removeClass("low-stock");r.find(".sold").html(i.UNPAID+i.PAID);r.find(".hold").html(i.UNPAID)})}function ShowBrandAvailable(n){$_availPanel.empty();$.each(_statisticData[n].VOUCHERS,function(t,i){var e=$('<span class="glyphicon glyphicon-edit" aria-hidden="true"><\/span>'),r,u,f;e.click(function(){ShowUpdateModal(n,i.SN,i.NO)});r=$('<span class="glyphicon glyphicon-trash" aria-hidden="true"><\/span>');r.click(function(){ShowDelModal(n,i.SN,i.NO)});u=$('<div class="opt"><\/div>');u.append(e).append(r);f=$(['<div class="col-md-12  col-xs-12 row-voucher">','<div class="number">','<div class="topup-number-sm">',i.NO,"<\/div>",'<div class="serial-number">',i.SN,"<\/div>","<\/div>","<\/div>"].join(""));f.append(u);$_availPanel.append(f)})}function alert(n,t){var i="alert-success",r;t&&(i="alert-danger");r=['<div class="alert '+i+' alert-dismissable add-voucher">','<button type="button" class="close" data-dismiss="alert">&times;<\/button>',n,"<\/div>"].join("");$_form.before(r)}function alertOnMain(n,t){var i="alert-success",r;t&&(i="alert-danger");r=['<div class="alert '+i+' alert-dismissable add-voucher">','<button type="button" class="close" data-dismiss="alert">&times;<\/button>',n,"<\/div>"].join("");$_availPanel.before(r)}var _statisticData,$_availPanel,$_form;$(function(){$_availPanel=$("#panelAvailable");$_form=$("#formVoucher");$(".brand-brief").click(function(){ChangeBrand($(this).attr("brand-type"))});$(".brand-brief").dblclick(function(){ShowModel("ADD",!1)});$.event.special.swipe.horizontalDistanceThreshold=100;$(".container").on("swipe",function(){ShowModel("ADD",!1)});$("#btnAdd").click(function(){AddVoucher();$("#confirmModal").modal("show")});$("#btnSave").click(function(){UpdateVoucher()});$("#btnDelete").click(function(){DeleteVoucher()});UpdateStatistic()});